#!/bin/sh -e

PORT=$(basename $(pwd)|awk -F- '{print $2}')
BACKEND_PORT=$(basename $(pwd)|awk -F- '{print $3}')
USER=$(id -un)
BASE=$(dirname $(readlink $0))
APP_DIR=$($BASE/readlink_canonical $BASE/app)

if [ -e $BASE/nginx ]; then
  NGINX=$BASE/nginx
else
  NGINX=nginx
fi

TEMP_BASE_DIR=/var/tmp/${USER}-nginx-${PORT}
if [ ! -d $TEMP_BASE_DIR ]; then
  mkdir -p $TEMP_BASE_DIR;
  chmod og-rwx $TEMP_BASE_DIR;
fi

cat <<EOF > nginx.conf
### DO NOT EDIT - THIS IS REGENERATED WHEN NGINX STARTS: SEE $0 ###
daemon off;

pid ${TEMP_BASE_DIR}/pid;  # we don't want this, but it's mandatory

worker_processes 2;

error_log ${APP_DIR}/log/nginx-errors.log;

events {
    worker_connections  1024;
}


http {
  access_log ${APP_DIR}/log/access.log;

  fastcgi_temp_path ${TEMP_BASE_DIR}/fastcgi;
  client_body_temp_path ${TEMP_BASE_DIR}/client-body 1 2;
  proxy_temp_path ${TEMP_BASE_DIR}/proxy;

  include       mime.types;
  default_type  application/octet-stream;

  sendfile        on;

  tcp_nopush     on;
  keepalive_timeout  65;
  tcp_nodelay        on;

  gzip  on;
  gzip_min_length  1100;
  gzip_buffers     4 8k;
  gzip_proxied     any;
  gzip_types       text/plain text/html text/xhtml text/css text/js text/csv;

  upstream backend {
    server 127.0.0.1:$BACKEND_PORT;
  }

  server {
    listen       127.0.0.1:${PORT};

    root ${APP_DIR}/public;
    index index.html index.htm;

    try_files  \$uri/index.html \$uri.html \$uri @backend;

    location @backend {
      proxy_set_header X-Real-IP       \$remote_addr;
      proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
      proxy_set_header Host            \$http_host;
      proxy_redirect off;
      proxy_pass http://backend;
    }

    error_page 500 502 503 504  /50x.html;
    location = /50x.html {
      root   html;
    }
  }
}
EOF

exec $NGINX -p $PWD/ -c nginx.conf || echo "do you need to create the symlink '$BASE/nginx?'"
